<!DOCTYPE html>
<html>
<head>
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>TheBot - Demo</title>
  <style>
      html, body {
          height: 100%;
      }

      body {
          min-height: 100%;
          margin: 0;
          padding: 0;
      }

      #canvas {
          min-width: 360px;
          min-height: 410px;
          height: 100%;
      }

      #hud {
        display: none;
        position: relative;
        width: 100%;
        border-top: 1px solid;
        border-bottom: 1px solid;
        margin: 10px 0;

        -webkit-transform-origin: top;
      }

      #snapshot {
        display: block;
        width: 320px;
        height: 240px;
        margin: 0 auto;
      }

      #controls {
        margin: 10px;
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 300px;
        z-index: -1;
        margin-left: -150px;
        top: 50%;
        margin-top: -192px;
        overflow: hidden;

        -webkit-transform-origin: bottom;
      }

      @media (min-height: 670px) {
        #hud {
          display: block;
        }

        #controls {
          top: inherit;
          margin-top: 20px;
        }
      }

      @media (min-height: 750px) {
        #controls {
          -webkit-transform: scale(1.2);
        }
      }

      @media (min-height: 800px) {
        #hud {
          -webkit-transform: scale(1.2);
        }
      }

      @media (min-height: 900px) {
        #hud {
          -webkit-transform: scale(1.6);
        }
      }

      @media (min-height: 950px) {
        #hud {
          -webkit-transform: scale(1.8);
        }
      }

      #hallo {
        display: block;
        margin: 5px auto;
        font-family: 'Roboto', sans-serif;
        font-weight: bold;
        font-size: 30px;
        width: 102px;
      }

      /* Container */
      #wheel {
        position: relative;
        margin: 20px auto;
        width: 300px;
        height: 300px;
        background: white;
        z-index: -1;
        overflow: hidden;
      }

      /* Shine on the steering wheel */
      #wheel::before {
          -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        border: 4px solid #AFAFAF;
          height: 93%;
          left: 3.5%;
          opacity: 1;
          top: 3.5%;
          width: 93%;
          content:'';
        position: absolute;
        border-radius: 50%;
        background:trasparent;
        z-index:3;

      }

      /* Round Part of the wheel */
      #wheel_b {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: black;
        background: -webkit-gradient(linear, center top, center bottom, from(#1C1C1C), color-stop(0.02, #1C1C1C), color-stop(0.09, #000000), color-stop(0.93, #000000), to(#596378));
        background: -webkit-linear-gradient(center top , #1C1C1C, #1C1C1C 2%, #000000 9%, #000000 93%, #5C5C5C);
        background: -moz-linear-gradient(center top , #1C1C1C, #1C1C1C 2%, #000000 9%, #000000 93%, #5C5C5C);
        background: -ms-linear-gradient(center top , #1C1C1C, #1C1C1C 2%, #000000 9%, #000000 93%, #5C5C5C);

        border-right: 2px solid rgba(89, 99, 120, 0.4);
          border-top: 2px solid rgba(89, 99, 120, 0.4);
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;

        -moz-transform: rotate(-135deg);
        -webkit-transform: rotate(-135deg);
        -ms-transform: rotate(-135deg);
        -o-transform: rotate(-135deg);

      }

      /* Steering wheel interior */
      #wheel_c {
        height: 80%;
          left: 10%;
          position: absolute;
          top: 10%;
          width: 80%;
        border-radius: 50%;
        background: white;
        overflow:hidden;
        z-index:2;

        -moz-transform: rotate(135deg);
        -webkit-transform: rotate(135deg);
        -ms-transform: rotate(135deg);
        -o-transform: rotate(135deg);
      }

      /* Top Left Part */
      #wheel_c::before {
          content:'';
        height: 8.3%;
          left: 0px;
          position: absolute;
          top: 30%;
          width: 47.917%;
        border-radius: 19%;
        background: black;
        background: -webkit-gradient(linear, center top, center bottom, from(#000000), color-stop(0.3, #000000), color-stop(0.5, #f00), color-stop(0.7, #000000), to(#000000));
        background: -webkit-linear-gradient(top center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);
        background: -moz-linear-gradient(top center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);
        background: -ms-linear-gradient(top center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);

        transform:rotate(20deg);
        -ms-transform:rotate(20deg);
        -moz-transform: rotate(20deg);
        -webkit-transform:rotate(20deg);
        -o-transform:rotate(20deg);

        -moz-transform-origin: 20% 120%;
        -ms-transform-origin: 20% 120%;
        -webkit-transform-origin: 20% 120%;
        -o-transform-origin: 20% 120%;
      }

      /* Top Right Part */
      #wheel_c::after {
          content:'';
        height: 8.3%;
          right: 0px;
          position: absolute;
          top: 30%;
          width: 47.917%;
        border-radius: 19%;
        background: black;
        background: -webkit-gradient(linear, center top, center bottom, from(#000000), color-stop(0.3, #000000), color-stop(0.5, #f00), color-stop(0.7, #000000), to(#000000));
        background: -webkit-linear-gradient(top center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);
        background: -moz-linear-gradient(top center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);
        background: -ms-linear-gradient(top center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);

        transform:rotate(-20deg);
        -ms-transform:rotate(-20deg);
        -moz-transform: rotate(-20deg);
        -webkit-transform:rotate(-20deg);
        -o-transform:rotate(-20deg);

        -moz-transform-origin: 80% 120%;
        -ms-transform-origin: 80% 120%;
        -webkit-transform-origin: 80% 120%;
        -o-transform-origin: 80% 120%;
      }

      /* Bottom Center Part */
      #wheel_d {
        height: 49.17%;
          bottom: -10px;
          position: absolute;
        left: 44%;
          width: 9.17%;
        border-radius: 19%;
        background: black;
        background: -webkit-gradient(linear, left center, right center, from(#000000), color-stop(0.3, #000000), color-stop(0.5, #f00), color-stop(0.7, #000000), to(#000000));
        background: -webkit-linear-gradient(left center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);
        background: -moz-linear-gradient(left center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);
        background: -ms-linear-gradient(left center , #000000, #000000 30%, #f00 50%, #000000 70%, #000000);
      }

      /* Center Center Part */
      #beep {
        border-radius: 100px 100px 180px 180px / 20px 20px 250px 250px;
          height: 29.17%;
          left: 30%;
          position: absolute;
          top: 38%;
          width: 37.5%;
          z-index: 1;
        background: black;
        background: -webkit-gradient(linear, center top, center bottom, from(#000000), to(#323232));
        background: -moz-linear-gradient(center top , #000000, #323232);
        background: -webkit-linear-gradient(center top , #000000, #323232);
        background: -ms-linear-gradient(center top , #000000, #323232);
        background: -o-linear-gradient(center top , #000000, #323232);
      }

      #dash {
          font-family: 'Roboto', sans-serif;
          font-size: 20px;
          text-align: center;
          background: #373737;
          color: #fff;
          border-radius: 100px 100px 180px 180px / 20px 20px 250px 250px;
          content: "";
          height: 35.71%;
          left: 8%;
          position: absolute;
          top: 8%;
          width: 85.71%;
          padding-top: 5px;
      }
  </style>
</head>
<body>
  <div id="canvas">
    <div id="hud">
      <img id="snapshot" src="file:///Users/kid0m4n/Desktop/snapshot%20(1).jpeg" />
    </div>
    <div id="controls">
      <div id="hallo">TheBot</div>
      <div id="wheel">
        <div id="wheel_b">
          <div id="wheel_c">
            <div id="wheel_d"></div>
            <div id="beep">
              <div id="dash"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var testMode = window.location.search.indexOf('test') > -1
      , canvas = document.getElementById('canvas')
      , canvasWidth = canvas.clientWidth
      , canvasHeight = canvas.clientHeight
      , maxTurn = 45.0
      , turnScale = ((canvasWidth - 60) / 2) / maxTurn
      , minSpeed = 10.0
      , maxSpeed = 50.0
      , maxRealSpeed = 150.0
      , minRealSpeed = 60.0
      , virtRealSpeedScale = (maxRealSpeed - minRealSpeed) / (maxSpeed - minSpeed)
      , speedScale = (canvasHeight - 435) / maxSpeed
      , wheel = document.getElementById('wheel')
      , $dash = $('#dash')
      , ix = null
      , iy = null
      , amp = 0.0
      , turn = 0.0
      , xf = null
      , yf = null
      , k = 0.6
      , scaledAmp = 0.0
      , scaledTurn = 90.0
      , highColor = '#E80000'
      , mediumColor = '#FF9933'
      , safeColor = '#373737'
      , xAccelScale = 1.8
      , yAccelScale = 1.6

    function handleOrientationEvent(event) {
      var x = event.beta
        , y = event.gamma

      if (isNaN(x) || isNaN(y))
        return

      if (!ix && !iy) {
        ix = x
        iy = y

        xf = x
        yf = y
      } else {
        xf = k * xf + (1.0 - k) * x
        yf = k * yf + (1.0 - k) * y

        var px = (xf - ix) * xAccelScale
          , py = (yf - iy) * yAccelScale

        amp = px < 0.0 ? -px : 0.0
        if (amp > maxSpeed)
          amp = maxSpeed

        if (Math.abs(py) > maxTurn)
          py = maxTurn * (py/Math.abs(py))

        turn = py
      }
    }

    function represent() {
      wheel.style.webkitTransform = 'rotate(' + turn + 'deg)'

      scaledAmp = (amp <= minSpeed) ? 0.0 : (amp - minSpeed) * virtRealSpeedScale + minRealSpeed
      scaledTurn = 90.0 + turn

      $dash.text(amp.toFixed())

      var safety = 5

      if (amp > 35)
        safety--
      if (amp > 20)
        safety--

      if (scaledTurn < 90) {
        if (scaledTurn < 75)
          safety--
        if (scaledTurn < 65)
          safety--
      } else {
          if (scaledTurn > 105)
            safety--
          if (scaledTurn > 115)
            safety--
      }

      var color = safety > 4 ? safeColor : (safety > 3) ? mediumColor : highColor
      $dash.css('background-color', color)
    }

    function reset() {
      ix = iy = null
    }

    function sendOrientationToCar() {
      $.post("/turn/" + scaledTurn.toFixed() + "/speed/" + scaledAmp.toFixed())
    }

    function updateSnapshot() {
      $("#snapshot").attr("src", "/snapshot?" + new Date().getTime())
    }

    window.addEventListener("deviceorientation", handleOrientationEvent, true)

    setInterval(represent, 20)

    if (!testMode) {
      setInterval(sendOrientationToCar, 200)
      setInterval(updateSnapshot, 1000)
    }
  </script>
</div>
</body>
</html>
